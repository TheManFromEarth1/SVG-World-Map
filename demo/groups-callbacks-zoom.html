<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>SVG World Map Demo</title>
        <style>
            html { width: 100%; height: 100%; overflow: hidden; }
            body { width: 100%; height: 100%; margin: 0; font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif; }
            a { color: #CCCCCC; text-decoration: dotted underline; cursor: pointer; }
            button { cursor: pointer; width: 100%; padding: 5px 0; font-size: 13px; text-align: center; border: none;  border-radius: 5px; color: #FFFFFF; background-color: #444444; }
            button:hover { background-color: #999999; }
            ul { list-style: none; padding: 0; }
            ul li { cursor: pointer; padding: 5px; border-radius: 5px; }
            ul li:hover { background-color: #444444; }
            .box { position: fixed; padding: 10px; background-color: rgba(100, 100, 100, .95); color: #FFFFFF; border-radius: 5px; overflow-y: scroll; }
            .hide { font-size: 25px; position: fixed; margin-left: 585px; margin-top: -5px; text-decoration: none; color: #FFFFFF; }
            .hidden { display: none; }
            #container, #svg-world-map { width: 100%; height: 100%; }
            #info { bottom: 10px; left: calc(50vw - 300px); width: 600px; height: 200px; }
            #groups { top: 10px; right: 10px; }
            #countries { top: 10px; left: 10px; max-width: 230px; max-height: calc(100vh - 40px); }
        </style>
	</head>
	<body>
		<div id="container">
		    <object id="svg-world-map" data="../src/world-states-provinces.svg" type="image/svg+xml"></object>
        </div>
        <div id="countries" class="box"></div>
        <div id="groups" class="box"></div>
        <div id="info" class="box hidden"></div>
        <script src="../src/svg-world-map.js"></script>
        <!-- Let's test SVG pan zoom integration: --> 
        <!-- CDN: <script src="//cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script> -->
        <script src="svg-pan-zoom.min.js"></script>
        <script>

            // Global variables
            var myWorldMap;
            var mySVG = document.getElementById('svg-world-map'); 

            // Wait for asynchronous svg load
            loadSVGMap(mySVG);
            function loadSVGMap(mySVG) {
                mySVG.addEventListener("load", function() {

                    // Load country data via async request, then startup map init
                    loadCountryData().then(function(countryData) {

                        // Custom options
                        var params = { 
                            showLabels: true, // Attention: Showing country title names may take longer to load
                            groupBy: [ "region", "sovereignty" ],
                            mapClick: "mapClick"
                        };

                        // Startup
                        myWorldMap = svgWorldMap(mySVG, params, countryData);

                        // Controls
                        buildCountryControls();
                        buildGroupControls();

                        // Test svgPanZoom 
                        svgPanZoom = svgPanZoom(mySVG, { minZoom: 1, dblClickZoomEnabled: false });  //controlIconsEnabled: true, beforePan: beforePan
                    });

                }, false);
            }

            // Custom callback function for map click, defined in 'options.mapClick'
            function mapClick(country) {
                if (country != undefined && country.id != 'Ocean') {
                    var nation = country.country; // Get parent nation
                    if (nation != undefined) {
                        var out = '<a class="hide" onclick="document.getElementById(\'info\').classList.add(\'hidden\')">Ã—</a>';
                        out += 'Country: ' + country.id;
                        out += '<br><a onmouseover="highlightCountry(\'' + nation.id + '\')" onmouseout="myWorldMap.out(\'' + nation.id + '\')" onclick="myWorldMap.click(\'' + nation.id + '\')">Nation: ' + nation.name + '</a><br>';
                        out += 'Official name: ' + nation.longname + '<br>Code: ' + nation.id + '<br>';
                        out += '<a onmouseout="highlightGroup(\'' + nation.region + '\', \'region\', \'out\')" onmouseover="highlightGroup(\'' + nation.region + '\', \'region\', \'over\')" onclick="highlightGroup(\'' + nation.region + '\', \'region\', \'click\')">Region: ' + nation.region + '</a><br>';
                        out += 'Population: ' + formatInteger(nation.population);
                        out += '<br><br>All countries / provinces / states in ' + nation.name + ':<br>';
                        nation.provinces.forEach(function(province) { 
                            out += '<a onmouseover="myWorldMap.over(\'' + province.id + '\')" onmouseout="myWorldMap.out(\'' + province.id + '\')" onclick="myWorldMap.click(\'' + province.id + '\')">' + province.id + '</a>, '; 
                        }); 
                        document.getElementById("info").innerHTML = out;
                        document.getElementById("info").classList.remove("hidden");
                    }
                } else {
                    //console.log('Country not found');
                    //document.getElementById("info").classList.add("hidden");
                }
            }

            // Demo country list
            function buildCountryControls() {
                var out = '<u>Countries:</u><br><ul>';
                for (var countryid in myWorldMap.countries) {
                    out += '<li id="' + countryid + '" onmouseover="highlightCountry(\'' + countryid + '\')" onmouseout="myWorldMap.out(\'' + countryid + '\')" onclick="myWorldMap.click(\'' + countryid + '\')">[' + countryid + '] ' + myWorldMap.countries[countryid].name + '</li>'; 
                }
                out += '</ul>';
                document.getElementById("countries").innerHTML = out;
            }

            // Demo control buttons
            function buildGroupControls() {
                var regionNames = { AF: "Afrika", AN: "Antarctica", AS: "Asia", EU: "Europe", NA: "North America", OC: "Ocania", SA: "South America" };
                var out = '';
                // Add country label toggle 
                out += '<button onclick="myWorldMap.labels(\'all\')">Country labels</button><br><br>';
                out += '<button onclick="myWorldMap.labels(\'micro\')">Microstate labels</button><br><br><br>';
                for (var group in myWorldMap.countryGroups) {
                    out += '<u>' + group.charAt(0).toUpperCase() + group.slice(1) + ':</u><br><ul>'; // Capitalize first letter
                    for (var subgroup in myWorldMap.countryGroups[group]) {
                        if (group == 'region') { var name = regionNames[subgroup]; } else { var name = subgroup; }
                        out += '<li id="' + subgroup + '" onmouseout="highlightGroup(\'' + subgroup + '\', \'' + group + '\', \'out\')" onmouseover="highlightGroup(\'' + subgroup + '\', \'' + group + '\', \'over\')" onclick="highlightGroup(\'' + group + '\', \'' + group + '\', \'click\')">' + name + '</li>'; 
                    }
                    out += '</ul><br>';
                }
                document.getElementById("groups").innerHTML = out;
            }

            // Highlight country 
            function highlightCountry(id) {
                var color = getHighlightColor(id);
                myWorldMap.update({ [id]: color });
            }

            // Highlight country group
            function highlightGroup(id, group, trigger) {
                var group = myWorldMap.countryGroups[group];
                if (trigger == 'out') {
                    for (var country in group[id]) {
                        myWorldMap.out(country);
                    }
                } else if (trigger == 'over' || trigger == 'click') {
                    var color = getHighlightColor(id);
                    var data = {};
                    for (var country in group[id]) {
                        data[country] = color; // Set data for map update
                    }
                    myWorldMap.update(data);
                }
            }

            // Get some random color from the element name
            function getHighlightColor(id) {
                // Get the numbers for the id letters, add them, square them and take the last 6 digits
                var number = parseInt(id.substr(0, 1).charCodeAt(0) + '' + id.substr(1, 2).charCodeAt(0));
                var hex = '#' + parseInt(number * number).toString().substr(-6, 6);
                return hex;
            }

            // Asynchronous JSON load
            async function loadCountryData() {
                let response = await fetch('../src/countrydata.json');
                let data = await response.json();
                return data;
            }

            // Number format helper function
            function formatInteger(number) {
                return new Intl.NumberFormat('en-GB').format(number);
            }

        </script>
    </body>
</html>
