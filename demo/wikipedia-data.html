<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>SVG World Map Demo</title>
        <link rel="stylesheet" type="text/css" href="css/demo.css">
	</head>
	<body>
        <div id="wikidata" class="box">
            Wikipedia page URL<br>
            <input type="text" id="pageurl" value="https://en.wikipedia.org/wiki/Member_states_of_the_Commonwealth_of_Nations"><br>
            <button id="loaddata" onclick="myWorldMap.reset();loadWikipediaData();">Load data</button>
            <button id="reset" onclick="myWorldMap.reset();document.getElementById('tabledata').classList.add('hidden');">Reset map</button><br>
            Load example page<br>
            <button onclick="setWikiURL(0)">Commonwealth</button>
            <button onclick="setWikiURL(1)">South America</button>
            <button onclick="setWikiURL(2)">Provinces of China</button>
            <button onclick="setWikiURL(3)">Council of Eur.</button>
            <button onclick="setWikiURL(4)">African Union</button>
            <button onclick="setWikiURL(5)">OPEC</button>
            <button onclick="setWikiURL(6)">NATO</button>
            <button onclick="setWikiURL(7)">BRICS</button>
        </div>
        <div id="code" class="box hidden">
        </div>
        <div id="labels" class="box">
            <button onclick="myWorldMap.labels('all')">Country labels</button>
            <button onclick="myWorldMap.labels('micro')">Microstate labels</button>
        </div>
        <div id="overout" class="box">
            Path over: <span id="over"></span><br><br>
            Path out: <span id="out"></span><br><br>
            Path click: <span id="click"></span>
        </div>
        <div id="countries" class="box"></div>
        <script src="../src/svg-world-map.js"></script>
        <script src="js/svg-pan-zoom.min.js"></script>
        <script src="js/pretty-json.js"></script>
        <script>
            // Global variables
            var myWorldMap;

            // Load SVG World Map
            loadSVGWorldMap();
            async function loadSVGWorldMap() {
                // Startup SVG World Map
                myWorldMap = await svgWorldMap({ bigMap: true, /* set to false for smaller, faster map */ showOcean: false, showAntarctica: false, showLabels: false, showInfoBox: true, provinceStroke: { out: '#666666',  over: '#666666',  click: '#333333' } });
                // Build controls 
                buildCountryControls();
                // SvgPanZoom 
                svgPanZoom = svgPanZoom(myWorldMap.worldMap, { minZoom: 1, dblClickZoomEnabled: false }); 
                svgPanZoom.pan({ x: 0, y: 50 }); // Set map to better start position without antarctica
                // Fadein with opacity 
                document.getElementById('svg-world-map-container').style.opacity = 1;
            }

            // Wait for asynchronous Wikipedia JSON load and pass data to library 
            async function loadWikipediaData() {
                var pageUrl = document.getElementById('pageurl').value.split('/');
                var pageTitle = pageUrl[pageUrl.length-1];
                document.getElementById('code').innerHTML = 'Loading Wikipedia data...';
                document.getElementById('code').classList.remove('hidden');
                const url = "https://en.wikipedia.org/w/api.php?" +
                    new URLSearchParams({
                        origin: "*",
                        action: "parse",
                        format: "json",
                        prop: "text",
                        page: pageTitle
                    });
                try {
                    const req = await fetch(url);
                    const json = await req.json();
                    var htmlData = json.parse.text["*"];
                    myWorldMap.table(htmlData);
                } catch (e) {
                    //console.error(e);
                }
            }

            // Callback function for HTML table parsing, defined in 'options.mapTable'
            function mapTable(tableData) {
                if (tableData != '') {
                    // JSON output syntax highlighting 
                    var tableOutput = JSON.stringify(tableData, null, 2);
                    var close = '<a class="hide" onclick="document.getElementById(\'tabledata\').classList.add(\'hidden\')">Ã—</a>';
                    document.getElementById('code').innerHTML = "";
                    jsonDisplay.outputPretty(tableOutput);
                    document.getElementById('code').innerHTML = close + document.getElementById('code').innerHTML;
                    // Update country colors 
                    var updateData = {};
                    var updateColor = getHighlightColor(tableOutput.substr(33, 10)); // Get random highlight color
                    for (var countryid in tableData) {
                        // Use (background) color from original data table, if there was some
                        var keys = Object.keys(tableData[countryid]);
                        var lastElem = tableData[countryid][keys[keys.length-2]];
                        //console.log(lastElem);
                        //console.log(lastElem.color);
                        if (lastElem.color != undefined) {
                            updateData[countryid] = lastElem.color;
                        // Or just the generated random color 
                        } else {
                            updateData[countryid] = updateColor;
                        }
                    }
                    myWorldMap.update(updateData);
                }
            }

            // Default callback functions, custom names can be defined in 'options.mapOver', 'options.mapOut' and 'options.mapClick'
            function mapOver(country) {
                document.getElementById("over").innerHTML = country.id;
            }

            function mapOut(country) {
                document.getElementById("out").innerHTML = country.id;
            }

            function mapClick(country) {
                if (country != '') {
                    document.getElementById("click").innerHTML = country.id;
                }
            }

            // Load Wikipedia demo page
            function setWikiURL(urlNumber) {
                var wikiPages = [
                    'https://en.wikipedia.org/wiki/Member_states_of_the_Commonwealth_of_Nations',
                    'https://en.wikipedia.org/wiki/List_of_South_American_countries_by_population',
                    'https://en.wikipedia.org/wiki/Provinces_of_China',
                    'https://en.wikipedia.org/wiki/Member_states_of_the_Council_of_Europe',
                    'https://en.wikipedia.org/wiki/Member_states_of_the_African_Union',
                    'https://en.wikipedia.org/wiki/OPEC',
                    'https://en.wikipedia.org/wiki/Member_states_of_NATO',
                    'https://en.wikipedia.org/wiki/BRICS',
                ];
                document.getElementById("pageurl").value = wikiPages[urlNumber];
                document.getElementById("loaddata").click();
            }

            // Demo country list
            function buildCountryControls() {
                var out = '<ul>';
                for (var countryid in myWorldMap.countries) {
                    out += '<li id="' + countryid + '" onmouseout="myWorldMap.out(\'' + countryid + '\')" onmouseover="myWorldMap.over(\'' + countryid + '\')" onclick="myWorldMap.click(\'' + countryid + '\')">[' + countryid + '] ' + myWorldMap.countries[countryid].name + '</li>'; 
                }
                out += '</ul>';
                document.getElementById("countries").innerHTML = out;
            }

            // Get some random color from the element name
            function getHighlightColor(id) {
                // Get the numbers for the id letters, add them, square them and take the last 6 digits
                var number = parseInt(id.substr(0, 1).charCodeAt(0) + '' + id.substr(1, 2).charCodeAt(0));
                var hex = '#' + parseInt(number * number).toString().substr(-6, 6);
                return hex;
            }
        </script>
    </body>
</html>
