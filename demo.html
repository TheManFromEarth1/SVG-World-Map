<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>SVG World Map Demo</title>
        <style>
            html { width: 100%; height: 100%; overflow: hidden; }
            body { width: 100%; height: 100%; margin: 0; font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif; }
            ul { list-style: none; padding: 0; }
            ul li { cursor: pointer; padding: 5px; border-radius: 5px; }
            ul li:hover { background-color: #444444; }
            .box { position: fixed; padding: 10px; background-color: rgba(100, 100, 100, .95); color: #FFFFFF; overflow-y: scroll;  }
            #container, #svg-world-map { width: 100%; height: 100%; }
            #info { bottom: 10px; right: 10px; max-width: 400px; max-height: 300px; }
            #groups { top: 10px; right: 10px; }
            #countries { top: 10px; left: 10px; max-width: 300px; max-height: calc(100vh - 40px); }
        </style>
	</head>
	<body>
		<div id="container">
			<object id="svg-world-map" data="World_States_Provinces.svg" type="image/svg+xml"></object>
        </div>
        <div id="info" class="box"></div>
        <div id="groups" class="box"></div>
        <div id="countries" class="box"></div>
        <!--<script src="svg-pan-zoom.min.js"></script>-->
        <script src="svg-world-map.js"></script>
        <script>

            var myWorldMap;
            var mySVG = document.getElementById('svg-world-map'); 

            // Wait for asynchronous svg load
            loadSVGMap(mySVG);
            function loadSVGMap(mySVG) {
                mySVG.addEventListener("load", function() {
                    myWorldMap = svgWorldMap(mySVG, { 
                        //countryFill: '#999', // currently disabled
                        //countryStroke: '#F00', 
                        //countryStrokeWidth: '2',
                        //provinceFill: '#666',
                        provinceStroke: '#666', 
                        //provinceStrokeWidth: '0',
                        //groupCountries: true, 
                        groupBy: [ "region" ],
                        mapClick: "mapClick"
                    });
                    //console.log(myWorldMap);
                    buildCountryControls();
                    buildGroupControls();

                    // TODO: Check svg-pan-zoom.js integration - it inserts a viewport layer into the SVG DOM, this fucks up the internal hierarchy
                    //svgPanZoom = svgPanZoom(mySVG, { minZoom: 1, dblClickZoomEnabled: false });  //controlIconsEnabled: true, beforePan: beforePan
                }, false);
            }

            // Custom callback function for map click, defined in 'options.mapClick'
            function mapClick(country, nation) {
                if (country == undefined) {
                    country = '(No province found in ' + nation.name + ')';
                } else {
                    country = country.id;
                }
                document.getElementById("info").innerHTML = 'Country: ' + country + '<br>Nation: ' + nation.name + '<br>Code: ' + nation.id + '<br>Region: ' + nation.region;
                document.getElementById("info").innerHTML += '<br><br>All countries / provinces / states in ' + nation.name + ':<br>';
                nation.provinces.forEach(function(province) { document.getElementById("info").innerHTML += province.id + '<br>'; }); 
            }

            // Demo country list
            function buildCountryControls() {
                var out = 'Countries:<br><ul>';
                for (var country in myWorldMap.countries) {
                    out += '<li id="' + country + '" onclick="myWorldMap.countryClick()">' + myWorldMap.countries[country].name + '</li>'; 
                }
                out += '</ul>';
                document.getElementById("countries").innerHTML = out;
            }

            // Demo control buttons
            // TODO: Rewrite for several groups
            function buildGroupControls() {
                var regionNames = { AF: "Afrika", AN: "Antarctica", AS: "Asia", EU: "Europe", NA: "North America", OC: "Ocania", SA: "South America" };
                var out = 'Regions:<br><ul>';
                for (var region in myWorldMap.countryGroups['region']) {
                    out += '<li id="' + region + '" onclick="highlightGroup(\'region\')">' + regionNames[region] + '</li>'; 
                }
                out += '</ul>';
                document.getElementById("groups").innerHTML = out;
            }

            // Highlight country group
            function highlightGroup(group) {
                var id = event.srcElement.id;
                var group = myWorldMap.countryGroups[group];
                var color = getGroupColor(group, id);
                for (var country in group[id]) {
                    group[id][country].provinces.forEach(function(province) { 
                        province.setAttribute('fill', color);
                    }); 
                }
            }

            // Get some random colors from the current and 2 other group elements
            function getGroupColor(group, id) {
                var keys = Object.keys(group);
                var pos = keys.indexOf(id);
                // Check the position of the key, if it's too close to the end take the other elements from before and not after the key
                keys = (pos < (keys.length-2) ? keys.slice(pos, pos+3) : keys.slice(pos-2, pos+1));
                // Get number for first character of every group key, put them together and cut, if hexcode is too long
                var hex = ('#' + keys[0].substr(0, 1).charCodeAt(0) + keys[1].substr(0, 1).charCodeAt(0) + keys[2].substr(0, 1).charCodeAt(0)).substr(0, 7); 
                return hex;
            }

            // TODO: Rewrite to use 'async function loadCountryData()'?
            // Load file helper function
            function loadFile(url, callback) {
                var xobj = new XMLHttpRequest();
                //xobj.overrideMimeType("application/json");
                //xobj.open('GET', 'countries.json', true);
                xobj.open('GET', url, true);
                xobj.onreadystatechange = function() {
                    if (xobj.readyState === 4 && xobj.status === 200) {
                        callback(xobj.responseText);
                    }
                };
                xobj.send(null);
            }

            // Asynchronous JSON load
            async function loadCountryData() {
                let response = await fetch('countrydata.json');
                let data = await response.json();
                return data;
            }

        </script>
    </body>
</html>
